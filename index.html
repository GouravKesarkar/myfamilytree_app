<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family Tree</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f8b500">

  <style>
    :root{
      --bg-a: linear-gradient(135deg,#f7f7f9,#f1f6ff);
      --card-bg:#ffffff;
      --accent:#3b82f6;
      --photo-size:84px;
      --ring-width:6px;
      --font:'Segoe UI', Roboto, Arial, sans-serif;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:var(--font);
      background: var(--bg-a);
      color:#222;
    }
    header{
      padding:18px 20px;
      display:flex;
      align-items:center;
      gap:18px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
      background:linear-gradient(90deg,#111827,#0f172a);
      color:white;
    }
    header .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:0.2px;
    }
    main {
        height: calc(100vh - 72px);
        overflow: auto;
        position: relative;
        touch-action: none; /* enables pinch zoom */
        -webkit-overflow-scrolling: touch;
    }

    .scroll-wrap {
        display: inline-block;
        padding: 30px 80px;
        position: relative;
        min-width: max-content;
        transform-origin: center top;
        transition: transform 0.25s ease;
        touch-action: pan-x pan-y;
    }

    .tree-root {
        display: inline-block;
        position: relative;
    }

    .person-node{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      position:relative;
      min-width:160px;
    }

    .couple{
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,0.9);
      padding:10px 14px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(12,18,25,0.06);
      border:2px solid rgba(0,0,0,0.04);
    }

    .person-card{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:110px;
      text-align:center;
    }

    .photo{
      width:var(--photo-size);
      height:var(--photo-size);
      border-radius:50%;
      display:inline-block;
      box-sizing:content-box;
      position:relative;
      flex-shrink:0;
      background-size:cover;
      background-position:center;
    }

    .photo.ring{
      padding: var(--ring-width);
      border-radius:999px;
      background-clip:padding-box;
    }

    .name{
      font-weight:700;
      font-size:14px;
      color:#0b1220;
    }
    .life{
      font-size:12px;
      color:#6b7280;
    }

    .children{
      margin-top:26px;
      display:flex;
      gap:36px;
      align-items:flex-start;
      justify-content:center;
      position:relative;
    }

    .marriage{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:#f59e0b;
      font-size:16px;
    }

    .collapse-btn{
      position:absolute;
      right: -12px;
      top: 6px;
      background:#fff;
      border-radius:999px;
      padding:6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      cursor:pointer;
      font-size:12px;
      border:1px solid rgba(0,0,0,0.06);
    }

    svg.lines{
      position:absolute;
      top:0; left:0;
      pointer-events:none;
      overflow:visible;
      width:100%;
      height:100%;
    }

    .legend{ display:none; }

    /* Zoom buttons */
    .zoom-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999;
    }
    .zoom-btn {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.15s;
    }
    .zoom-btn:hover {
      transform: scale(1.1);
    }

    @media (max-width:900px){
      .tree-root{ padding:20px; min-width:800px; }
      .person-node{ min-width:140px; }
    }

  </style>
</head>
<body>
  <header>
    <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#6d28d9,#34d399);display:flex;align-items:center;justify-content:center;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5c2 0 3 1 4 2 1 1 2 2 2 4s-1 3-2 4-3 2-4 2-3-1-4-2-2-2-2-4 1-3 2-4 2-2 4-2z" stroke="#fff" stroke-width="1.2"/></svg>
    </div>
    <div class="title" style="flex: 1; text-align: center;">The Family Tree</div>
    <div style="flex:1"></div>
    <div><button id="installBtn" style="display:none; margin-top:10px;">üì≤ Install App</button></div>
  </header>

  <main id="mainArea">
    <div class="legend" id="legend"></div>
    <div class="scroll-wrap" id="scrollWrap">
      <div id="tree" class="tree-root">
        <svg class="lines" id="linesSvg"></svg>
      </div>
    </div>
  </main>

  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomIn">Ôºã</button>
    <button class="zoom-btn" id="zoomOut">Ôºç</button>
  </div>

  <footer>
    <p>Family Tree | ¬© 2025 GK | All rights reserved</p>
  </footer>

<script>
const COMMON_COLOR = '#3b82f6';
let zoomLevel = 1;
const scrollWrap = document.getElementById('scrollWrap');
const mainArea = document.getElementById('mainArea');

function setZoom(level){
  zoomLevel = Math.min(Math.max(level, 0.4), 2);
  scrollWrap.style.transform = `scale(${zoomLevel})`;
  requestAnimationFrame(drawAllLines);
}
document.getElementById('zoomIn').onclick = ()=>setZoom(zoomLevel + 0.1);
document.getElementById('zoomOut').onclick = ()=>setZoom(zoomLevel - 0.1);

// Ctrl + scroll
mainArea.addEventListener('wheel', e=>{
  if(e.ctrlKey){
    e.preventDefault();
    setZoom(zoomLevel - e.deltaY * 0.001);
  }
},{passive:false});

// Pinch zoom
let touchStartDist = 0;
mainArea.addEventListener('touchstart', e=>{
  if(e.touches.length === 2){
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    touchStartDist = Math.hypot(dx, dy);
  }
},{passive:false});
mainArea.addEventListener('touchmove', e=>{
  if(e.touches.length === 2 && touchStartDist){
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const newDist = Math.hypot(dx, dy);
    const scaleChange = (newDist / touchStartDist);
    setZoom(zoomLevel * scaleChange);
    touchStartDist = newDist;
  }
},{passive:false});
mainArea.addEventListener('touchend', e=>{
  if(e.touches.length < 2) touchStartDist = 0;
});

function el(tag, cls='', html=''){ 
  const d=document.createElement(tag); 
  if(cls) d.className=cls; 
  if(html) d.innerHTML=html; 
  return d; 
}

fetch('family.json').then(r=>{
  if(!r.ok) throw new Error('Could not load family.json.');
  return r.json();
}).then(data=>{
  const root = document.getElementById('tree');

  function renderPerson(person){
    const node = el('div','person-node');
    const couple = el('div','couple');

    function personCard(p){
      const pc = el('div','person-card');
      const placeholder = p.photo || ('https://via.placeholder.com/180x180.png?text=' + encodeURIComponent(p.name.split(' ')[0] || 'P'));
      const ring = el('div','photo ring');
      ring.style.padding = 'var(--ring-width)';
      ring.style.background = COMMON_COLOR;
      const inner = el('div','photo');
      inner.style.width = 'var(--photo-size)';
      inner.style.height = 'var(--photo-size)';
      inner.style.backgroundImage = 'url(' + placeholder + ')';
      inner.style.borderRadius = '50%';
      ring.appendChild(inner);
      pc.appendChild(ring);
      pc.appendChild(el('div','name',p.name||''));
      pc.appendChild(el('div','life',(p.birth||'') + (p.death?(' - '+p.death):(p.birth?' - Present':''))));
      return pc;
    }

    if(person.husband){
      couple.appendChild(personCard(person.husband));
    } else if(person.name && !person.wife){
      couple.appendChild(personCard(person));
    }

    if(person.husband && person.wife){
      couple.appendChild(el('div','marriage','üíç'));
      couple.appendChild(personCard(person.wife));
    } else if(person.wife && !person.husband){
      couple.appendChild(personCard(person.wife));
    }

    node.appendChild(couple);

    if(person.children && person.children.length>0){
      const childrenWrap = el('div','children');
      person.children.forEach(ch => childrenWrap.appendChild(renderPerson(ch)));
      const collapse = el('div','collapse-btn','‚àí');
      collapse.title='Collapse / Expand children';
      collapse.onclick=(e)=>{
        e.stopPropagation();
        if(childrenWrap.style.display==='none'){childrenWrap.style.display='';collapse.innerText='‚àí';}
        else {childrenWrap.style.display='none';collapse.innerText='+';}
        requestAnimationFrame(drawAllLines);
      };
      node.appendChild(collapse);
      node.appendChild(childrenWrap);
    }

    // keep centered like original
    setTimeout(() => {
      const main = document.querySelector('main');
      requestAnimationFrame(() => {
        main.scrollLeft = (main.scrollWidth - main.clientWidth) / 2;
      });
    }, 100);

    return node;
  }

  const rootNode = renderPerson(data);
  root.appendChild(rootNode);
  requestAnimationFrame(drawAllLines);
}).catch(err=>{
  document.getElementById('tree').innerText = 'Error loading family.json ‚Äî '+err.message;
});

function drawAllLines(){
  const svg=document.getElementById('linesSvg');
  const zoomLevel = parseFloat(document.getElementById('tree').style.transform.match(/scale\((.*?)\)/)?.[1] || 1);
  const tree=document.getElementById('tree');
  const rect=tree.getBoundingClientRect();
  svg.setAttribute('width',rect.width);
  svg.setAttribute('height',rect.height);
  while(svg.firstChild)svg.removeChild(svg.firstChild);
  const parentNodes=tree.querySelectorAll('.person-node');
  parentNodes.forEach(parentNode=>{
    const childrenWrap=parentNode.querySelector(':scope > .children');
    if(!childrenWrap||childrenWrap.style.display==='none')return;
    const couple=parentNode.querySelector(':scope > .couple');
    if(!couple)return;
    const parentRect=couple.getBoundingClientRect();
    const children=Array.from(childrenWrap.children).filter(ch=>ch.classList.contains('person-node'));
    children.forEach(child=>{
      const childCouple=child.querySelector(':scope > .couple');
      if(!childCouple)return;
      const childRect=childCouple.getBoundingClientRect();
      const x1 = ((parentRect.left + parentRect.width/2) - rect.left) / zoomLevel;
      const y1 = ((parentRect.bottom) - rect.top) / zoomLevel;
      const x2 = ((childRect.left + childRect.width/2) - rect.left) / zoomLevel;
      const y2 = ((childRect.top) - rect.top) / zoomLevel;
      const midY=(y1+y2)/2;
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d',`M ${x1} ${y1} C ${x1} ${midY} ${x2} ${midY} ${x2} ${y2}`);
      path.setAttribute('stroke','#9ca3af');
      path.setAttribute('stroke-width','2');
      path.setAttribute('fill','none');
      path.setAttribute('stroke-linecap','round');
      path.setAttribute('opacity','0.9');
      svg.appendChild(path);
    });
  });
}

let resizeTimer;
window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(drawAllLines,80);});
document.getElementById('tree').addEventListener('scroll',()=>{requestAnimationFrame(drawAllLines);});

document.getElementById('zoomIn').onclick = () => {
  zoomLevel = Math.min(zoomLevel + 0.1, 2);
  updateZoom();
};

document.getElementById('zoomOut').onclick = () => {
  zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
  updateZoom();
};

function updateZoom() {
  const tree = document.getElementById('tree');
  tree.style.transform = `scale(${zoomLevel})`;
  tree.style.transformOrigin = 'center top';

  // ‚úÖ redraw lines after zoom
  requestAnimationFrame(drawAllLines);
}

</script>

<script>
let deferredPrompt;
const installBtn=document.getElementById("installBtn");
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.style.display="block";
});
installBtn.addEventListener("click",async()=>{
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  const {outcome}=await deferredPrompt.userChoice;
  console.log("User response:",outcome);
  deferredPrompt=null;
  installBtn.style.display="none";
});
window.addEventListener("appinstalled",()=>{
  console.log("‚úÖ PWA installed");
  installBtn.style.display="none";
});
</script>
</body>
</html>
